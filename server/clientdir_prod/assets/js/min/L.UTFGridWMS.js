L.UTFGridWMS=L.TileLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",format:"application/json",srs:"EPSG:900913",imagetype:"utfgrid",version:"1.1.1",width:512,height:512},options:{resolution:4,pointerCursor:!0,mouseInterval:66,crs:null,uppercase:!1},_mouseOn:null,_mouseOnTile:null,_tileCharCode:null,_cache:null,_idIndex:null,_throttleMove:null,initialize:function(t,e){this._url=t;var i=L.Util.extend({},this.defaultWmsParams);for(var o in e)o in this.options||(i[o]=e[o]);e=L.Util.setOptions(this,e),i.width=i.height=this.defaultWmsParams.width*(e.detectRetina&&retina?2:1),this.wmsParams=i},_updateCursor:function(){},onAdd:function(t){this._cache={},this._idIndex={},L.TileLayer.prototype.onAdd.call(this,t),this._throttleMove=L.Util.throttle(this._move,this.options.mouseInterval,this),this.options.pointerCursor&&(this._updateCursor=function(t){this._container.style.cursor=t}),t.on("boxzoomstart",this._disconnectMapEventHandlers,this),t.on("boxzoomend",this._throttleConnectEventHandlers,this),this._connectMapEventHandlers()},onRemove:function(){var t=this._map;t.off("boxzoomstart",this._disconnectMapEventHandlers,this),t.off("boxzoomend",this._throttleConnectEventHandlers,this),this._disconnectMapEventHandlers(),this._updateCursor(""),L.TileLayer.prototype.onRemove.call(this,t)},createTile:function(t){return this._loadTile(t),document.createElement("div")},setUrl:function(t,e){return this._cache={},L.TileLayer.prototype.setUrl.call(this,t,e)},_connectMapEventHandlers:function(){this._map.on("click",this._onClick,this),this._map.on("mousemove",this._throttleMove,this)},_disconnectMapEventHandlers:function(){this._map.off("click",this._onClick,this),this._map.off("mousemove",this._throttleMove,this)},_throttleConnectEventHandlers:function(){setTimeout(this._connectMapEventHandlers.bind(this),100)},_update:function(t,e){L.TileLayer.prototype._update.call(this,t,e)},getTileUrl:function(t){this._crs=map.options.crs;var e=this._tileCoordsToBounds(t),i=this._crs.project(e.getNorthWest()),o=this._crs.project(e.getSouthEast()),n=(this._wmsVersion>=1.3&&this._crs===EPSG4326?[o.y,i.x,i.y,o.x]:[i.x,o.y,o.x,i.y]).join(","),s=L.TileLayer.prototype.getTileUrl.call(this,t),s=s+L.Util.getParamString(this.wmsParams,s,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+n;return s},_loadTile:function(t){var e=this.getTileUrl(t),i=this._tileCoordsToKey(t),o=this;this._cache[i]||corslite(e,function(t,e){if(t)return void o.fire("error",{error:t});var n=JSON.parse(e.responseText);o._cache[i]=n,L.Util.bind(o._handleTileLoad,o)(i,n)},!0)},_handleTileLoad:function(t,e){},_onClick:function(t){this.fire("click",this._objectForEvent(t))},_move:function(t){if(null!=t.latlng){var e=this._objectForEvent(t);e._tileCharCode!==this._tileCharCode?(this._mouseOn&&(this.fire("mouseout",{latlng:t.latlng,data:this._mouseOn,_tile:this._mouseOnTile,_tileCharCode:this._tileCharCode}),this._updateCursor("")),e.data&&(this.fire("mouseover",e),this._updateCursor("pointer")),this._mouseOn=e.data,this._mouseOnTile=e._tile,this._tileCharCode=e._tileCharCode):e.data&&this.fire("mousemove",e)}},_objectForEvent:function(t){if(t.latlng){var e=this._map,i=e.project(t.latlng),o=this.options.tileSize,n=this.options.resolution,s=Math.floor(i.x/o),r=Math.floor(i.y/o),a=Math.floor((i.x-s*o)/n),l=Math.floor((i.y-r*o)/n),h=e.options.crs.scale(e.getZoom())/o;s=(s+h)%h,r=(r+h)%h;var c=this._tileCoordsToKey({z:e.getZoom(),x:s,y:r}),u=this._cache[c];if(!u)return{latlng:t.latlng,data:null,_tile:null,_tileCharCode:null};var d=u.grid[l].charCodeAt(a),_=this._utfDecode(d),p=u.keys[_],f=u.data[p];return u.data.hasOwnProperty(p)||(f=null),{latlng:t.latlng,data:f,id:f?f.id:null,_tile:c,_tileCharCode:c+":"+d}}},_dataForCharCode:function(t,e){var i=this._cache[t],o=this._utfDecode(e),n=i.keys[o],s=i.data[n];return i.data.hasOwnProperty(n)||(s=null),s},_utfDecode:function(t){return t>=93&&t--,t>=35&&t--,t-32},_utfEncode:function(t){var e=t+32;return e>=34&&e++,e>=92&&e++,e}}),L.utfGridWMS=function(t,e){return new L.UTFGridWMS(t,e)};